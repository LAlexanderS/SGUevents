{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Восстановление пароля</title>
    <link rel="stylesheet" href="{% static "css/styles.css" %}"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="{% static "bootstrap/css/bootstrap.min.css" %}">
    <link rel="stylesheet" href="{% static "css/login_styles.css" %}"/>
</head>
<body>

<div class="container">
    <h2 class="mb-4 text-center">Восстановление пароля</h2>

    <!-- Место для сообщений -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div id="messageArea" class="alert alert-info" style="display: none;"></div>

    <!-- Шаг 1: Ввод логина -->
    {% if step == 'username' %}
    <form method="post" action="{% url 'users:password_reset' %}">
        {% csrf_token %}
        <div class="mb-3" style="text-indent: 0;">
            <label for="username" class="form-label">Логин</label>
            <input type="text" class="form-control" id="username" name="username" placeholder="Введите ваш логин" required>
        </div>
        <button type="submit" class="btn w-100 enter" style="width: 100% !important; max-width: 100% !important;">Отправить код</button>
    </form>
    {% endif %}

    <!-- Шаг 2: Ввод кода -->
    {% if step == 'code' %}
    <form id="codeForm">
        {% csrf_token %}
        <input type="hidden" id="reset_code_id" value="{{ reset_code_id }}">
        <input type="hidden" id="username" value="{{ username }}">
        <div class="mb-3" style="text-indent: 0;">
            <label for="code" class="form-label">Код восстановления</label>
            <input type="text" class="form-control" id="code" name="code" placeholder="Введите 6-значный код" maxlength="6" pattern="[0-9]{6}" required>
            <small class="form-text text-muted">Код отправлен в ваш Telegram</small>
        </div>
        <button type="submit" class="btn w-100 enter" style="width: 100% !important; max-width: 100% !important;">Подтвердить</button>
    </form>

    <div class="mt-3 text-center">
        <button type="button" id="resendBtn" class="btn btn-link" style="color: #0088BB;">Отправить код повторно</button>
        <span id="resendTimer" style="display: none; color: #666;"></span>
    </div>
    {% endif %}

    <div class="mt-3 text-center">
        <a href="{% url 'users:login' %}" style="color: #0088BB;">Вернуться к входу</a>
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '='))
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
        }
    }
    return cookieValue;
}

{% if step == 'code' %}
let resendTimer = null;
let resendSeconds = 30;

function updateResendTimer() {
    const resendBtn = document.getElementById('resendBtn');
    const resendTimerEl = document.getElementById('resendTimer');
    
    if (resendSeconds > 0) {
        resendBtn.style.display = 'none';
        resendTimerEl.style.display = 'inline';
        resendTimerEl.textContent = `Повторная отправка возможна через ${resendSeconds} секунд`;
        resendSeconds--;
        resendTimer = setTimeout(updateResendTimer, 1000);
    } else {
        resendBtn.style.display = 'inline';
        resendTimerEl.style.display = 'none';
    }
}

// Запускаем таймер при загрузке страницы
updateResendTimer();

// Обработка формы ввода кода
document.getElementById('codeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const code = document.getElementById('code').value;
    const reset_code_id = document.getElementById('reset_code_id').value;
    const username = document.getElementById('username').value;
    const messageArea = document.getElementById('messageArea');
    
    if (code.length !== 6) {
        messageArea.style.display = 'block';
        messageArea.className = 'alert alert-danger';
        messageArea.textContent = 'Код должен состоять из 6 цифр';
        return;
    }
    
    fetch('{% url "users:password_reset_verify" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            code: code,
            reset_code_id: reset_code_id,
            username: username
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageArea.style.display = 'block';
            messageArea.className = 'alert alert-success';
            messageArea.textContent = data.message;
            setTimeout(() => {
                window.location.href = data.redirect_url;
            }, 2000);
        } else {
            messageArea.style.display = 'block';
            messageArea.className = 'alert alert-danger';
            messageArea.textContent = data.error;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        messageArea.style.display = 'block';
        messageArea.className = 'alert alert-danger';
        messageArea.textContent = 'Произошла ошибка при проверке кода';
    });
});

// Обработка повторной отправки кода
document.getElementById('resendBtn').addEventListener('click', function() {
    const reset_code_id = document.getElementById('reset_code_id').value;
    const username = document.getElementById('username').value;
    const messageArea = document.getElementById('messageArea');
    const resendBtn = document.getElementById('resendBtn');
    
    resendBtn.disabled = true;
    resendBtn.textContent = 'Отправка...';
    
    fetch('{% url "users:password_reset_resend" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            reset_code_id: reset_code_id,
            username: username
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageArea.style.display = 'block';
            messageArea.className = 'alert alert-success';
            messageArea.textContent = data.message;
            resendSeconds = 30;
            updateResendTimer();
        } else {
            messageArea.style.display = 'block';
            messageArea.className = 'alert alert-danger';
            messageArea.textContent = data.error;
            if (data.seconds_remaining) {
                resendSeconds = data.seconds_remaining;
                updateResendTimer();
            }
        }
        resendBtn.disabled = false;
        resendBtn.textContent = 'Отправить код повторно';
    })
    .catch(error => {
        console.error('Error:', error);
        messageArea.style.display = 'block';
        messageArea.className = 'alert alert-danger';
        messageArea.textContent = 'Произошла ошибка при отправке кода';
        resendBtn.disabled = false;
        resendBtn.textContent = 'Отправить код повторно';
    });
});

// Ограничение ввода только цифрами
document.getElementById('code').addEventListener('input', function(e) {
    this.value = this.value.replace(/[^0-9]/g, '');
});
{% endif %}
</script>

</body>
</html>

